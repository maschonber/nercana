<div class="log-view">
  <div class="log-header">
    <h2>Quest Log</h2>
    <span class="log-counter" *ngIf="log.length > 0">{{ log.length }} entries</span>
  </div>
  
  <div class="log-content">
    <ng-container *ngIf="log.length > 0; else emptyLog">
      <ul>
        <li *ngFor="let entry of log; let i = index" 
            [ngClass]="{'success-entry': entry.success, 'fail-entry': !entry.success, 'new-entry': isNewEntry(i),
                       'exploration-entry': entry.stepType === 'exploration',
                       'encounter-entry': entry.stepType === 'encounter',
                       'treasure-entry': entry.stepType === 'treasure'}">
          <span class="entry-time">[{{ entry.timestamp | date:'shortTime' }}]</span>
          <span class="entry-icon" *ngIf="entry.stepType">
            <i class="step-icon" [ngClass]="{
              'exploration-icon': entry.stepType === 'exploration',
              'encounter-icon': entry.stepType === 'encounter',
              'treasure-icon': entry.stepType === 'treasure'
            }">{{ getStepIcon(entry.stepType) }}</i>
          </span>
          <span class="entry-message">{{ entry.message }}</span>
          <span class="entry-rewards" *ngIf="hasRewards(entry)">
            <span class="experience-reward" *ngIf="getExperienceFromEntry(entry) > 0">
              +{{ getExperienceFromEntry(entry) }} XP
            </span>
            <span class="gold-reward" *ngIf="getGoldFromEntry(entry) > 0">
              +{{ getGoldFromEntry(entry) }} Gold
            </span>
          </span>
          
          <!-- Combat details toggle button for encounter entries with combat results -->
          <button 
            *ngIf="entry.stepType === 'encounter' && entry.combatResult" 
            class="combat-details-toggle" 
            (click)="toggleCombatDetails(i)"
            [attr.aria-expanded]="isCombatExpanded(i)"
            [title]="isCombatExpanded(i) ? 'Hide combat details' : 'Show combat details'">
            <span *ngIf="!isCombatExpanded(i)">▼ Details</span>
            <span *ngIf="isCombatExpanded(i)">▲ Hide</span>
          </button>
          
          <!-- Expanded combat details section -->
          <div *ngIf="entry.stepType === 'encounter' && entry.combatResult && isCombatExpanded(i)" class="combat-details">
            <!-- Combat outcome banner -->
            <div class="combat-outcome" [ngClass]="getCombatOutcomeClass(entry.combatResult.outcome)">
              {{ getCombatOutcomeText(entry.combatResult.outcome) }}
            </div>
            
            <!-- Monster information -->
            <div class="monster-info" *ngIf="entry.monster">
              <div class="monster-header">
                <h4>{{ entry.monster.name }}</h4>
                <span class="monster-type">{{ entry.monster.type }}</span>
              </div>
              <p class="monster-description">{{ entry.monster.description }}</p>
              <div class="stats-container">
                <div class="stat-item">
                  <span class="stat-label">Attack</span>
                  <span class="stat-value">{{ entry.monster.attack }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Defense</span>
                  <span class="stat-value">{{ entry.monster.defense }}</span>
                </div>
              </div>
            </div>
            
            <!-- Combat rounds -->
            <div class="combat-rounds">
              <h4>Combat Summary</h4>
              <div class="combat-round" *ngFor="let round of entry.combatResult.rounds">
                <div class="round-header">Round {{ round.roundNumber }}</div>
                
                <!-- Hero action -->
                <div class="combat-action hero-action">
                  <span class="action-label">You</span>
                  <span class="action-description">{{ round.heroAction.description }}</span>
                  <span *ngIf="round.heroAction.damage" class="damage-indicator">
                    {{ round.heroAction.damage }} damage
                  </span>
                </div>
                
                <!-- Monster action -->
                <div class="combat-action monster-action">
                  <span class="action-label">{{ entry.monster?.name }}</span>
                  <span class="action-description">{{ round.monsterAction.description }}</span>
                  <span *ngIf="round.monsterAction.damage" class="damage-indicator">
                    {{ round.monsterAction.damage }} damage
                  </span>
                </div>
                
                <!-- Health status after the round -->
                <div class="health-status">
                  <div class="health-bar-container">
                    <span class="health-label">You: {{ round.heroHealthAfter }} HP</span>
                    <div class="health-bar">
                      <div class="health-fill hero-health" 
                           [style.width.%]="getHealthPercentage(round.heroHealthAfter, entry.combatResult.rounds[0].heroHealthAfter)">
                      </div>
                    </div>
                  </div>
                  <div class="health-bar-container">
                    <span class="health-label">{{ entry.monster?.name }}: {{ round.monsterHealthAfter }} HP</span>
                    <div class="health-bar">
                      <div class="health-fill monster-health" 
                           [style.width.%]="getHealthPercentage(round.monsterHealthAfter, entry.monster?.maxHealth || 100)">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Combat summary -->
            <div class="combat-summary">
              <p>{{ entry.combatResult.summary }}</p>
            </div>
            
            <!-- Combat rewards recap -->
            <div class="combat-rewards" *ngIf="entry.combatResult.experienceGained > 0 || entry.combatResult.goldGained > 0">
              <h4>Rewards</h4>
              <div class="rewards-container">
                <span *ngIf="entry.combatResult.experienceGained > 0" class="experience-reward">
                  +{{ entry.combatResult.experienceGained }} XP
                </span>
                <span *ngIf="entry.combatResult.goldGained > 0" class="gold-reward">
                  +{{ entry.combatResult.goldGained }} Gold
                </span>
              </div>
            </div>
          </div>
        </li>
      </ul>
    </ng-container>
    <ng-template #emptyLog>
      <div class="empty-log">
        <p>No quests completed yet. Embark on a quest to see your adventures here!</p>
      </div>
    </ng-template>
  </div>
</div>
